---
title: "1_ComputeRepeatability"
author: "Ghais ZRIKI, Nicolas RODE"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document: 
    number_sections: yes
    theme: journal
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all() 
```

# Load count data 
```{r }
## Load count data for each observer
data <- readxl::read_excel(path=file.path(here::here(), "data", "raw_data", "DS_Counting_trials.xlsx"), sheet = "ObserverCountData")
## Load true counts for each sample
truecounts <- readxl::read_excel(path=file.path(here::here(), "data", "raw_data", "DS_Counting_trials.xlsx"), sheet = "TrueCounts")
head(data)
dim(data)

```

```{r }
head(d_original)
d_original$Person.ID<- as.factor(d_original$Person.ID)
d_original$Sample_ID<- as.factor(d_original$Sample_ID)
d_original$Incubation<- as.factor(d_original$Incubation)
summary(d_original)
require(tidyverse)
d = d_original %>%
  mutate(Counting_error=No_Larvae-No_of_Larvae) %>% 
  select(Counting_error,Time_Sec,Incubation, Round) %>% 
  group_by(Incubation, Round) %>%
  summarise(Counting_error_mean=mean(Counting_error),
            Time_Sec_mean=mean(Time_Sec))
 

# Comparing errors in counting between incubated and non-incubated samples
table(d_original$Previous_Experience,d_original$Incubation)
require(ggplot2)

G= d_original %>%
  mutate(Counting_error=No_Larvae - No_of_Larvae) %>% 
  select(Counting_error,Incubation, Round) %>%
  ggplot(aes(Incubation,Counting_error, fill=Round))+ geom_boxplot()
G
####
K=  d_original %>%
  mutate(Counting_error=abs(No_Larvae - No_of_Larvae)) %>% 
  select(Counting_error,Incubation) %>%
  kruskal.test(Counting_error~Incubation)

## IS the previous experience, repeating the counting, and the incubation of the sample influence the time nedded for the counting and errors in counting? 
# vaseline model, fits a mean, estimate the average error mean four the entire group but also individually 
require(lme4)
require(flexplot)
d = d_original %>%
  mutate(Counting_error=abs(No_Larvae-No_of_Larvae)) 
names(d)
head(d)
View(d)
baseline= lmer(Counting_error~1+(1|Person.ID), data=d)
summary(baseline)

# en average, across all theperson, the mean error is 1,79and the avarga from they will deviate by 3.80
# add effect in the model 

# fixed_Incubation effect 
fixed_Incubation_Prvious_ex= lmer(Counting_error~1+Incubation+Previous_Experience+(1|Person.ID), data=d)
summary(fixed_Incubation_Prvious_ex)


# random effect model: it is missleading to say taht this effect is random or fix, any time you have
# a random effect you also have a fix effect, there is no model when you have only random effect and no fix effect, 
# it is more appropriate to say is this a fix effect only or this a fix/random effect 

# fix a model where Previous experience is has both random and fix effect 
fixed_Incubation_Prvious_ex= lmer(Counting_error~1+Incubation+Previous_Experience+(1+ Previous_Experience|Person.ID), data=d)# ther is an average previous_ex effect on darkness,but there is also 
summary(fixed_Incubation_Prvious_ex)# diviation within person, some person may have a stronger relationship between previous_ex and error making than others

##### consider round? 
fixed_Incubation_Prvious_ex_Round= lmer(Counting_error~1+Incubation + Previous_Experience + Round +(1+ Previous_Experience|Person.ID), data=d)# ther is an average previous_ex effect on darkness,but there is also 
summary(fixed_Incubation_Prvious_ex_Round)# diviation within person, some person may have a stronger relationship between previous_ex and error making than others
```
